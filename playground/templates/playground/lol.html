{% load static %}
<html lang="en">
    <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type='text/css' href="{% static '/playground/css/lol.css' %}">
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous"/>
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous">
</script>


    <title>1인칭 주인공 시점</title>
    </head>
    
    <body>
        {% include 'header.html' %}

        <main class="main">
            <div class="main_top">
                <div class="main_top_wrap">
                    <video id="video_background" autoplay muted loop>    
                        <source src="{% static '/playground/images/background_top.mp4' %}" type="video/mp4">
                    </video>
                    <div class="main_top_text">
                        <p class="main_top_12">
                            <span class="main_top_1">위인을</span><br>
                            <span class="main_top_2">
                            <strong>선택하세요</strong>
                            </span>
                        </p>
                        <p class="main_top_3"> 
                            검색 혹은 카테고리를 통해 과학자와 수학자 중<br>
                            경험해보고 싶은 위인을 찾아 주인공이 되어 봅시다!
                        </p>
                    </div>

                </div>
            </div>


            <div class="main_center">
                
                <section class="nav_section">
                    <section class="nav_section">
                        <nav class="classification_bar">
                            <div class="nav_div">
                                <div class="function">
                                    
                                    <form id="searchForm" method="get" action="{% url 'index' %}">
                                        <input type="text" id="search_Input" name="search" placeholder="위인을 검색하세요" value="{{ search_query }}" autocomplete='off'>
                                        <input type="hidden" name="filter_option" value="{{ filter_option }}">
                                        <input type="hidden" name="categoryOption" value="{{ categoryOption }}">
                                        <button type="submit">검색</button>
                                    </form>

                                                          
                                    <form id="radioForm">
                                        <input type="hidden" name="search" value="{{ search_query }}">
                                        <input type="hidden" name="filter_option" value="{{ filter_option }}">

                                        <input type="radio" name="categoryOption" id="category0" value="0" checked onchange="this.form.submit()" {% if categoryOption == '0' %}checked{% endif %}>
                                        <label for="category0">전체<div class='nav_under'></div></label>
                                    
                                        <input type="radio" name="categoryOption" id="category1" value="1" onchange="this.form.submit()" {% if categoryOption == '1' %}checked{% endif %}>
                                        <label for="category1">과학자<div class='nav_under'></div></label>
                                    
                                        <input type="radio" name="categoryOption" id="category2" value="2" onchange="this.form.submit()" {% if categoryOption == '2' %}checked{% endif %}>
                                        <label for="category2">수학자<div class='nav_under'></div></label>

                                        <input type="radio" name="categoryOption" id="category3" value="3" onchange="this.form.submit()" {% if categoryOption == '3' %}checked{% endif %}> 
                                        <label for="category3">철학자<div class='nav_under'></div></label>

                                        <input type="radio" name="categoryOption" id="category4" value="4" onchange="this.form.submit()" {% if categoryOption == '4' %}checked{% endif %}>
                                        <label for="category4">음악가<div class='nav_under'></div></label>
                                    </form>
                                    
                            
                                    <form method="get" action="{% url 'index' %}">
                                        <select name="filter_option" onchange="this.form.submit()">
                                            <option value="" {% if filter_option|stringformat:"s" == '' %}selected{% endif %}>전체</option>
                                            <option value="1" {% if filter_option|stringformat:"s" == '1' %}selected{% endif %}>읽은 책</option>
                                            <option value="0" {% if filter_option|stringformat:"s" == '0' %}selected{% endif %}>안읽은 책</option>
                                            <input type="hidden" name="search" value="{{ search_query }}">
                                            <input type="hidden" name="categoryOption" value="{{ categoryOption }}">
                                        </select>
                                    </form>

                                </div>
                            </div>
                        </nav>
                      </section>
                </section>
                
                <section class="book_section">
                    <div class="book_div">
                        <div class="container">
                            {% if books %}
                                {% for book in books %}
                                    <div class="item">
                                        <form class="modal_check_form" id='form__{{ book.id }}'>
                                            <input type="hidden" name="search" value="{{ search_query }}">
                                            <input type="hidden" name="categoryOption" value="{{ categoryOption }}">
                                            <input type="hidden" name="filter_option" value="{{ filter_option }}">
                                            <input type="checkbox" name='checked_card' id="no_{{ book.id }}" class="modal_check" value="{{book.id}}"
                                            {% if checked_card == book.id|stringformat:"s" %}checked{% endif %} onchange="this.form.submit()">
                                        </form>
                                        <label for="no_{{ book.id }}">
                                            <div class="human" style="background-image: url('{{ book.card_image.url }}');"></div>
                                            {% if book.lock == 0 %}
                                                <div class = "lock_image"></div>
                                            {% endif %}
                                            <div class="name">
                                                {{book.name}}
                                            </div>
                                        </label>

                                        
                                        {% if book.id|stringformat:"s" == checked_card and book.lock == 1 %}
                                            <div>
                                                <div class="modal_window">
                                                    <label for="no_{{ book.id }}"></label>
                                                    <div class="modal_side">
                                                        <label for=""></label>
                                                        <input type="radio" name="side_option_{{ book.id }}" id="profile_side_{{ book.id }}" class="modal_radio" checked>
                                                        <label for="profile_side_{{ book.id }}">프로필</label>
                                                        <input type="radio" name="side_option_{{ book.id }}" id="episode1_side_{{ book.id }}" class="modal_radio">
                                                        <label for="episode1_side_{{ book.id }}">{{book.Ep_title_1}}</label>
                                                        <input type="radio" name="side_option_{{ book.id }}" id="episode2_side_{{ book.id }}" class="modal_radio">
                                                        <label for="episode2_side_{{ book.id }}">{{book.Ep_title_2}}</label>
                                                        <input type="radio" name="side_option_{{ book.id }}" id="episode3_side_{{ book.id }}" class="modal_radio">
                                                        <label for="episode3_side_{{ book.id }}">{{book.Ep_title_3}}</label>
                                                        <input type="radio" name="side_option_{{ book.id }}" id="quiz_side_{{ book.id }}" class="modal_radio">
                                                        <label for="quiz_side_{{ book.id }}">Quiz</label>
                                                    </div>
                                            
                                                    <div class="modal_main" id="modal_main_{{ book.id }}">
                                                        
                                                        <div class="profile_main profile_main_{{ book.id }}">
                                                            <div class="profile_contents">
                                                                <div class= "profile_img" style="background-image: url('{{ book.profile_image.url }}');" onclick="playAudio('/static/audio/sungji.mp3')"></div>
                                                                <div class= "profile_name">
                                                                    <span class="profile_name_span">{{book.name}}</span>
                                                                    <span class="profile_life_span"> {{book.year_of_life}}</span></div>
                                                                <div class= "profile_prologue">{{book.prologue}}</div>
                                                            </div>
                                                            <div class= "change_voice_face">
                                                                <form class="voice_face_form" id="voice_face_form_{{ book.id }}" method="get">
                                                                    <button type="submit" class="button_voice_face">적용</button> 
                                                                    <label class="voice_label"><input type="checkbox" class="voice_check" name='voice' value="{{ book.id }}" {% if voice == book.id|stringformat:"s" %}checked{% endif %}>음성 입히기</label> 
                                                                    <label class="face_label"><input type="checkbox" class="face_check" name='face' value="{{ book.id }}"{% if face == book.id|stringformat:"s" %}checked{% endif %}>얼굴 입히기</label>
                                                                    <input type="hidden" name="search" value="{{ search_query }}">
                                                                    <input type="hidden" name="categoryOption" value="{{ categoryOption }}">
                                                                    <input type="hidden" name="filter_option" value="{{ filter_option }}">
                                                                    <input type="hidden" name="checked_card" value ="{{ checked_card }}">

                                                                </form>
                                                            </div>
                                                        </div>

                                                        {% for episode in episodes %}
                                                            <div id="carouselExampleControls_{{episode.0.episode_number}}"  class="carousel slide  episode{{episode.0.episode_number}}_main_{{ book.id }}"  data-bs-ride="carousel" data-bs-interval="false">
                                                                <div class='carousel-inner scene_container'>
                                                                    {% for scene in episode %}
                                                                        <div class=" carousel-item scene scene_{{book.id}}_{{scene.episode_number}} scene_{{scene.scene_number}}"  id="scene_{{book.id}}_{{scene.episode_number}}_{{scene.scene_number}}" >
                                                                            <div class="wrap_scene_element">
                                                                                <div class='episode_image' 
                                                                                {% if face_change %}
                                                                                style="background-image: url('/static/playground/user/TMuD9dkOkEfHZCUjLoPo/{{face}}/face/{{book.id}}_{{scene.episode_number}}_{{scene.scene_number}}.png')"
                                                                                {% else %}style="background-image: url('/media/{{scene.image}}');"{% endif %}
                                                                                ></div>
                                                                                <div class="human_in_scene" id="h_{{book.id}}_{{scene.episode_number}}_{{scene.scene_number}}" 
                                                                                {% if voice_change %}
                                                                                onclick="playAudio('/static/playground/user/TMuD9dkOkEfHZCUjLoPo/{{voice}}/voice/{{book.id}}_{{scene.episode_number}}_{{scene.scene_number}}.mp3')"
                                                                                {% else %}onclick="playAudio('/media/{{scene.voice}}')"{% endif %}
                                                                                style="background-image: url('/media/{{scene.image_segment}}'); width : {{ scene.width }}px; height : {{ scene.height }}px; top : {{ scene.y_index }}px; right : {{ scene.x_index }}px;"
                                                                                onmouseover = "this.style.opacity = 1;" onmouseout = "this.style.opacity = 0;">                           
                                                                                </div>
                                                                                <div class='episode_scene_num'>
                                                                                    {{scene.scene_number}}/4
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    {% endfor %}
                                    
                                                                </div>
                                                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls_{{episode.0.episode_number}}" data-bs-slide="prev">
                                                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                                    <span class="visually-hidden">Previous</span>
                                                                  </button>
                                                                  <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls_{{episode.0.episode_number}}" data-bs-slide="next">
                                                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                                    <span class="visually-hidden">Next</span>
                                                                  </button>
                                                            </div>
                                                        {% endfor %}
                                                        
                                                        


                                                        <div class="quiz_main" id="quiz_main_{{ book.id }}">
                                                            
                                                            <form class="wrapper">
                                                                
                                                                    {% for quiz in book.quizzes.all %}
                                                                        <div class="card" id="quiz_{{quiz.quiz_index}}">
                                                                                                                                
                                                                                <div class='card__heading'><h5>Q{{quiz.quiz_index}}.<h5></div>
                                                                                <div class='card__text'>{{quiz.quiz_text}}</div>
                                                                                <div class="quiz_input_wrap">
                                                                                    <input type = "text" name="input_{{quiz.quiz_index}}" id="input_{{book.id}}_{{quiz.quiz_index}}">
                                                                                </div>                                                 
                                                                        </div>
                                                                        
                                                                        
                                                                    {% endfor %}                                                                      
                                                                                                         
                                                                <div id="quiz_button">
                                                                    <button type="submit" name="quiz_button_{{book.id}}">채점</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                
                                                </div>
                                                <label for="no_{{ book.id }}"></label>
                                                <script>
                                                    const radioButtons{{ book.id }} = document.querySelectorAll('input[name="side_option_{{ book.id }}"]');
                                                    const contentDivs{{ book.id }} = document.querySelectorAll('#modal_main_{{ book.id }} > div');
                                            
                                                    contentDivs{{ book.id }}[0].style.display = 'block';
                                            
                                                    radioButtons{{ book.id }}.forEach((radioButton, index) => {
                                                        radioButton.addEventListener('change', () => {
                                                            contentDivs{{ book.id }}.forEach((div, divIndex) => {
                                                                div.style.display = index === divIndex ? 'block' : 'none';
                                                            });
                                                        });
                                                    });
                                                </script>
                                                <script>
                                                    document.getElementById('no_{{ book.id }}').addEventListener('change', function () {
                                                        var popupDiv = document.querySelector('#form__{{ book.id }} + label + div');
                                                        popupDiv.style.display = this.checked ? 'block' : 'none';
                                                    });
                                                </script>                               
                                            </div>
                                            <script>
                                                for (var jj = 1; jj <= 3; jj++) {
                                                var myE = document.getElementById("scene_{{book.id}}_"+jj+"_1");
                                                myE.classList.add("active");}
                                            </script>
                                        {% endif %}
                                
                                    </div>
                                {% endfor %}
                            {% else %}
                                    <div class="no_result">
                                        조건에 맞는 위인이 없습니다.<br>
                                        다시 검색해 주세요.
                                    </div>
                            {% endif %}

                           
                        </div>
                    </div>
                </section>

            </div>
            <div class="main_bottom">
 
            </div>
        </main>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/gsap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/Flip.min.js"></script>
        <script>
            const quizs = ['quiz_1', 'quiz_2', 'quiz_3', 'quiz_4'];
            gsap.registerPlugin(Flip);

            const activeClass = "is-active";
            const inactiveClass = "is-inactive";
            const cards = document.querySelectorAll(".card");
        
            cards.forEach((card, idx) => {
                card.addEventListener("click", (event) => {
                    const id = event.target.id;
                    const nonSelected = quizs.filter((quiz) => quiz != id);
                    console.log(nonSelected);
                    const selected = document.querySelector(`div.card#${id}`);
                    selected.style.gridArea = '1 / 1 / 1 / 4';
                    nonSelected.forEach((quiz, index) => {
                        const target = document.querySelector(`div.card#${quiz}`);
                        target.style.gridArea = `2 / ${index + 1}`
                    })

                    // <input> 요소에서 발생한 클릭 이벤트를 무시
                    if (event.target.tagName === 'INPUT') {
                        return;
                    }
        
                    const state = Flip.getState(cards);
                    const isCardActive = card.classList.contains(activeClass);
        
                    cards.forEach((otherCard, otherIdx) => {
                        otherCard.classList.remove(activeClass);
                        otherCard.classList.remove(inactiveClass);
                        if (!isCardActive && idx !== otherIdx) {
                            otherCard.classList.add(inactiveClass);
                        }
                    });
        
                    if (!isCardActive) {
                        card.classList.add(activeClass);
                    }
        
                    Flip.from(state, {
                        duration: 1,
                        ease: "expo.out",
                        absolute: true
                    });
                });
            });
        </script>



        <script>
            var audio = new Audio(audioFile);;
            function playAudio(audioFile) {

                if (audio && !audio.paused) {
                return;
                }

                if (audio) {
                audio.pause();
                audio.currentTime = 0;
                }

                audio = new Audio(audioFile);

                audio.addEventListener('ended', function() {
                //pass
                });

                audio.play();
            }
        </script>
        <script>
            var audioPath = {{user_voice}};
        
            for (var i = 1; i <= 3; i++) {
                for (var j = 1; j <= 4; j++) {
                    var elementId = "h_" + {{book.id}} + "_" + i + "_" + j;
                    var element = document.getElementById(elementId);
        
                    if (element) {
                        element.onclick = function() {
                            playAudio(audioPath[i-1][j-1]);
                        };
                    }
                }
            }
        </script>
        {% include 'footer.html' %}
    </body>
</html>
