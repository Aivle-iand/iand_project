{% load static %}
<html lang="en">
    <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type='text/css' href="{% static '/playground/css/lol.css' %}">
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous"/>
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous">
</script>


    <title>1인칭 주인공 시점</title>
    </head>
    
    <body>
        {% include 'header.html' %}
        {% include 'cursor.html' %}
        {% include 'fonts.html' %}

        <main class="main">
            <div class="main_top">
                <div class="main_top_wrap">
                    <video id="video_background" autoplay muted loop>    
                        <source src="{% static '/playground/images/background_top.mp4' %}" type="video/mp4">
                    </video>
                    <div class="main_top_text">
                        <p class="main_top_12">
                            <span class="main_top_1">위인을</span><br>
                            <span class="main_top_2">
                            <strong>선택하세요</strong>
                            </span>
                        </p>
                        <p class="main_top_3"> 
                            검색 혹은 카테고리를 통해 과학자와 수학자 중<br>
                            경험해보고 싶은 위인을 찾아 주인공이 되어 봅시다!
                        </p>
                    </div>

                </div>
            </div>


            <div class="main_center">
                
                <section class="nav_section">
                    <section class="nav_section">
                        <nav class="classification_bar">
                            <div class="nav_div">
                                <div class="function">
                                    
                                    <form id="searchForm" method="get" action="{% url 'index' %}">
                                        <input type="text" id="search_Input" name="search" placeholder="위인을 검색하세요" value="{{ search_query }}" autocomplete='off'>
                                        <input type="hidden" name="filter_option" value="{{ filter_option }}">
                                        <input type="hidden" name="categoryOption" value="{{ categoryOption }}">
                                        <button type="submit">검색</button>
                                    </form>

                                                          
                                    <form id="radioForm">
                                        <input type="hidden" name="search" value="{{ search_query }}">
                                        <input type="hidden" name="filter_option" value="{{ filter_option }}">

                                        <input type="radio" name="categoryOption" id="category0" value="0" checked onchange="this.form.submit()" {% if categoryOption == '0' %}checked{% endif %}>
                                        <label for="category0">전체<div class='nav_under'></div></label>
                                    
                                        <input type="radio" name="categoryOption" id="category1" value="1" onchange="this.form.submit()" {% if categoryOption == '1' %}checked{% endif %}>
                                        <label for="category1">과학자<div class='nav_under'></div></label>
                                    
                                        <input type="radio" name="categoryOption" id="category2" value="2" onchange="this.form.submit()" {% if categoryOption == '2' %}checked{% endif %}>
                                        <label for="category2">수학자<div class='nav_under'></div></label>

                                        <input type="radio" name="categoryOption" id="category3" value="3" onchange="this.form.submit()" {% if categoryOption == '3' %}checked{% endif %}> 
                                        <label for="category3">철학자<div class='nav_under'></div></label>

                                        <input type="radio" name="categoryOption" id="category4" value="4" onchange="this.form.submit()" {% if categoryOption == '4' %}checked{% endif %}>
                                        <label for="category4">음악가<div class='nav_under'></div></label>
                                    </form>
                                    
                            
                                    <form method="get" action="{% url 'index' %}">
                                        <select name="filter_option" onchange="this.form.submit()">
                                            <option value="" {% if filter_option|stringformat:"s" == '' %}selected{% endif %}>전체</option>
                                            <option value="1" {% if filter_option|stringformat:"s" == '1' %}selected{% endif %}>읽은 책</option>
                                            <option value="0" {% if filter_option|stringformat:"s" == '0' %}selected{% endif %}>안읽은 책</option>
                                            <input type="hidden" name="search" value="{{ search_query }}">
                                            <input type="hidden" name="categoryOption" value="{{ categoryOption }}">
                                        </select>
                                    </form>

                                </div>
                            </div>
                        </nav>
                      </section>
                </section>
                
                <section class="book_section">
                    <div class="book_div">
                        <div class="container">
                            {% if books %}
                                {% for book in books %}
                                    <div class="item">
                                        <form class="modal_check_form" id='form__{{ book.id }}'>
                                            <input type="hidden" name="search" value="{{ search_query }}">
                                            <input type="hidden" name="categoryOption" value="{{ categoryOption }}">
                                            <input type="hidden" name="filter_option" value="{{ filter_option }}">
                                            <input type="checkbox" name='checked_card' id="no_{{ book.id }}" class="modal_check" value="{{book.id}}"
                                            {% if checked_card == book.id|stringformat:"s" %}checked{% endif %} onchange="this.form.submit()">
                                        </form>
                                        <div class ="name_img_wrap">
                                            <label for="no_{{ book.id }}">
                                                <div class="human" style="background-image: url('{{ book.card_image.url }}');"></div>
                                                {% if book.lock == 0 %}
                                                    <div class = "lock_image"></div>
                                                {% endif %}
                                                <div class="name">
                                                    {{book.name}}
                                                </div>
                                            </label>
                                        </div>
                                        
                                        {% if book.id|stringformat:"s" == checked_card and book.lock == 1 %}
                                            <div>
                                                <div class="modal_window">
                                                    <label for="no_{{ book.id }}"></label>
                                                    <div class="modal_side">
                                                        <label for=""></label>
                                                        <input type="radio" name="side_option_{{ book.id }}" id="profile_side_{{ book.id }}" class="modal_radio" checked>
                                                        <label for="profile_side_{{ book.id }}">프로필</label>
                                                        <input type="radio" name="side_option_{{ book.id }}" id="episode1_side_{{ book.id }}" class="modal_radio">
                                                        <label for="episode1_side_{{ book.id }}">{{book.Ep_title_1}}</label>
                                                        <input type="radio" name="side_option_{{ book.id }}" id="episode2_side_{{ book.id }}" class="modal_radio">
                                                        <label for="episode2_side_{{ book.id }}">{{book.Ep_title_2}}</label>
                                                        <input type="radio" name="side_option_{{ book.id }}" id="episode3_side_{{ book.id }}" class="modal_radio">
                                                        <label for="episode3_side_{{ book.id }}">{{book.Ep_title_3}}</label>
                                                        <input type="radio" name="side_option_{{ book.id }}" id="quiz_side_{{ book.id }}" class="modal_radio">
                                                        <label for="quiz_side_{{ book.id }}">Quiz</label>
                                                    </div>
                                            
                                                    <div class="modal_main" id="modal_main_{{ book.id }}">
                                                        
                                                        <div class="profile_main profile_main_{{ book.id }}">
                                                            <div class="profile_contents">
                                                                <div class= "profile_img" style="background-image: url('{{ book.profile_image.url }}');" onclick="playAudio('/static/audio/sungji.mp3')"></div>
                                                                <div class= "profile_name">
                                                                    <span class="profile_name_span">{{book.name}}</span>
                                                                    <span class="profile_life_span"> {{book.year_of_life}}</span></div>
                                                                <div class= "profile_prologue">{{book.prologue}}</div>
                                                            </div>
                                                            <div class= "change_voice_face">
                                                                <form class="voice_face_form" id="voice_face_form_{{ book.id }}" data-score-url="{% url 'voice_face_change' checked_card %}" method="POST">
                                                                    {% csrf_token %}
                                                                        <button type="submit" class="button_voice_face"
                                                                        {% if not request.user.is_authenticated %} disabled {% endif %}>적용</button>
                                                                        <label class="voice_label"><input type="checkbox" class="voice_check" name='voice' value="{{ book.id }}" {% if voice == book.id|stringformat:"s" %}checked{% endif %}>음성 입히기</label>
                                                                        <label class="face_label"><input type="checkbox" class="face_check" name='face' value="{{ book.id }}"{% if face == book.id|stringformat:"s" %}checked{% endif %}>얼굴 입히기</label>
                                                                       
                                                                </form>
                                                            </div>
                                                        </div>

                                                        {% for episode in episodes %}
                                                            <div id="carouselExampleControls_{{episode.0.episode_number}}"  class="carousel slide  episode{{episode.0.episode_number}}_main_{{ book.id }}"  data-bs-ride="carousel" data-bs-interval="false">
                                                                <div class='carousel-inner scene_container'>
                                                                    {% for scene in episode %}
                                                                        <div class=" carousel-item scene scene_{{book.id}}_{{scene.episode_number}} scene_{{scene.scene_number}}"  id="scene_{{book.id}}_{{scene.episode_number}}_{{scene.scene_number}}" >
                                                                            <div class="wrap_scene_element">
                                                                                <div class='episode_image'
                                                                                {% if face_change and request.user.is_authenticated %}
                                                                                style="background-image: url('/static/playground/user/TMuD9dkOkEfHZCUjLoPo/{{face}}/face/{{book.id}}_{{scene.episode_number}}_{{scene.scene_number}}.png')"
                                                                                {% else %}style="background-image: url('/media/{{scene.image}}');"{% endif %}
                                                                                ></div>
                                                                                <div class="human_in_scene" id="h_{{book.id}}_{{scene.episode_number}}_{{scene.scene_number}}"
                                                                                {% if voice_change and request.user.is_authenticated %}
                                                                                onclick="playAudio('/static/playground/user/TMuD9dkOkEfHZCUjLoPo/{{voice}}/voice/{{book.id}}_{{scene.episode_number}}_{{scene.scene_number}}.mp3')"
                                                                                {% else %}onclick="playAudio('/media/{{scene.voice}}')"{% endif %}
                                                                                style="background-image: url('/media/{{scene.image_segment}}'); width : {{ scene.width }}px; height : {{ scene.height }}px; top : {{ scene.y_index }}px; right : {{ scene.x_index }}px;"
                                                                                onmouseover = "this.style.opacity = 1;" onmouseout = "this.style.opacity = 0;">                          
                                                                                </div>
                                                                                <div class='episode_scene_num'>
                                                                                    {{scene.scene_number}}/4
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    {% endfor %}
                                    
                                                                </div>
                                                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls_{{episode.0.episode_number}}" data-bs-slide="prev">
                                                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                                    <span class="visually-hidden">Previous</span>
                                                                  </button>
                                                                  <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls_{{episode.0.episode_number}}" data-bs-slide="next">
                                                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                                    <span class="visually-hidden">Next</span>
                                                                  </button>
                                                            </div>
                                                        {% endfor %}
                                                        
                                                        


                                                        <div class="quiz_main" id="quiz_main_{{ book.id }}">
                                                            
                                                            <form class="wrapper" id="quizForm" data-score-url="{% url 'score_quiz' book.id %}" method="POST" >
                                                                {% csrf_token %}
                                                                    {% for quiz in book.quizzes.all %}
                                                                        <div class="card" id="quiz_{{quiz.quiz_index}}">
                                                                                                                                
                                                                                <div class='card__heading'><h5>Q{{quiz.quiz_index}}.<h5></div>
                                                                                <div class='card__text'>{{quiz.quiz_text}}</div>
                                                                                <div class="quiz_input_wrap">
                                                                                    <input type = "text" name="input_{{quiz.quiz_index}}" id="input_{{book.id}}_{{quiz.quiz_index}}">
                                                                                </div>                                                 
                                                                        </div>
                                                                        
                                                                        
                                                                    {% endfor %}
                                                                                                                                                                              
                                                            </form>
                                                            <div class="button_quiz" id="quiz_button_container">
                                                                <button id="quiz_buttonn" type="submit" form="quizForm" name="quiz_button_{{book.id}}">채점</button>
                                                            </div>

                                                            <div id="resultForm">
                                                                <p id="quizResult"></p>
                                                                <form class="wrapper" id="quizForm" data-score-url="{% url 'score_quiz' book.id %}" method="POST" >
                                                                        {% for quiz in book.quizzes.all %}
                                                                            <div class="result_card" id="quiz_{{quiz.quiz_index}}">
                                                                                                                                    
                                                                                    <div class='result__heading'><h5>Q{{quiz.quiz_index}}.<h5></div>
                                                                                    <div class='result__text'>{{quiz.quiz_text}}</div>
                                                                                    <div class="quiz_input_wrap">
                                                                                        <input type = "text" name="input_{{quiz.quiz_index}}" id="input_{{book.id}}_{{quiz.quiz_index}}">
                                                                                    </div>                                                 
                                                                            </div>
                                                                        {% endfor %}   
                                                                                                                                                     
                                                                </form>
                                                                        <div id="reward_button_container">
                                                                        <button id="reward_button" class="reward_button" type="submit">리워드 받기</button>
                                                                            <div id="rewardIcon" style="display: none;">
                                                                                <script src="https://cdn.lordicon.com/lordicon.js"></script>
                                                                                <lord-icon
                                                                                    id = lord_icon
                                                                                    src="https://cdn.lordicon.com/qnwzeeae.json"
                                                                                    trigger="loop"
                                                                                    style="width:250px;height:250px;">
                                                                                </lord-icon>
                                                                            </div>
                                                                        <button id="restart_button" class="restart_button" type="submit">재도전</button>
                                                                        </div>
                                                            </div>
                                                        </div>
                                                        


  
                                                    </div>
                                                
                                                </div>
                                                <label for="no_{{ book.id }}"></label>
                                                <script>
                                                    const radioButtons{{ book.id }} = document.querySelectorAll('input[name="side_option_{{ book.id }}"]');
                                                    const contentDivs{{ book.id }} = document.querySelectorAll('#modal_main_{{ book.id }} > div');
                                            
                                                    contentDivs{{ book.id }}[0].style.display = 'block';
                                            
                                                    radioButtons{{ book.id }}.forEach((radioButton, index) => {
                                                        radioButton.addEventListener('change', () => {
                                                            contentDivs{{ book.id }}.forEach((div, divIndex) => {
                                                                div.style.display = index === divIndex ? 'block' : 'none';
                                                            });
                                                        });
                                                    });
                                                </script>
                                                <script>
                                                    document.getElementById('no_{{ book.id }}').addEventListener('change', function () {
                                                        var popupDiv = document.querySelector('#form__{{ book.id }} + label + div');
                                                        popupDiv.style.display = this.checked ? 'block' : 'none';
                                                    });
                                                </script>                               
                                            </div>
                                            <script>
                                                for (var jj = 1; jj <= 3; jj++) {
                                                var myE = document.getElementById("scene_{{book.id}}_"+jj+"_1");
                                                myE.classList.add("active");}
                                            </script>
                                        {% endif %}
                                
                                    </div>
                                {% endfor %}
                            {% else %}
                                    <div class="no_result">
                                        조건에 맞는 위인이 없습니다.<br>
                                        다시 검색해 주세요.
                                    </div>
                            {% endif %}

                           
                        </div>
                    </div>
                </section>

            </div>
            <div class="main_bottom">
 
            </div>
        </main>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/gsap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/Flip.min.js"></script>
        <script>
            
            document.addEventListener('DOMContentLoaded', () => {
                gsap.registerPlugin(Flip);
              
                // 카드의 초기 grid-area를 지정
                const initialGridAreas = {
                  'quiz_1': '1 / 1 / 1 / 4',
                  'quiz_2': '2 / 1 ',
                  'quiz_3': '2 / 2 ',
                  'quiz_4': '2 / 3 ',
                };
              
                const cards = document.querySelectorAll(".card");
              
                // 페이지 로드 시 각 카드의 grid-area 설정
                cards.forEach((card) => {
                    card.style.gridArea = initialGridAreas[card.id];
                    // '1 / 1 / 1 / 4' 위치에 있는 카드만 visible
                    if (card.style.gridArea === initialGridAreas[card.id]) {
                    card.querySelector('.card__text').style.visibility = 'visible';
                    } else {
                    card.querySelector('.card__text').style.visibility = 'hidden';
                    }
                });
                
                
                
                const activeClass = "is-active";
                const inactiveClass = "is-inactive";
              
                cards.forEach((card) => {
                  card.addEventListener("click", () => {
                    // <input> 요소에서 발생한 클릭 이벤트 무시
                    if (event.target.tagName === 'INPUT') {
                        return;
                    }
                    
                    // 현재 카드가 이미 '1 / 1 / 1 / 4' 위치에 있으면 이벤트 무시
                    if (card.style.gridArea === '1 / 1 / 1 / 4') {
                        return; // 이벤트 핸들러를 종료
                    }
                    const state = Flip.getState(cards);
                    
                    const isCardActive = card.classList.contains(activeClass);
              
                    // 클릭한 카드의 상태를 변경
                    if (!isCardActive) {
                      // 모든 카드를 비활성화하고 클릭한 카드만 활성화
                      cards.forEach((otherCard) => {
                        otherCard.classList.remove(activeClass);
                        otherCard.classList.add(inactiveClass);
                        otherCard.querySelector('.card__text').style.visibility = 'visible';
                      });
                      card.classList.add(activeClass);
                      card.querySelector('.card__text').style.visibility = 'visible';
                      card.style.gridArea = '1 / 1 / 1 / 4';
                    } else {
                      card.classList.remove(activeClass);
                      card.querySelector('.card__text').style.visibility = 'hidden';
                    }
              
                    // 클릭하지 않은 카드들의 위치를 조정
                    let cardIndex = 1;
                    cards.forEach((otherCard) => {
                      if (!otherCard.classList.contains(activeClass)) {
                        otherCard.style.gridArea = `2 / ${cardIndex++} / auto / auto`;
                        otherCard.querySelector('.card__text').style.visibility = 'hidden';
                      }
                    });
              
                    // GSAP Flip 애니메이션을 실행
                    Flip.from(state, {
                      duration: 1,
                      ease: "expo.out",
                      absolute: true,
                      onComplete: () => {
                        
                      }
                    });
                  });
                });
              });
              
        </script>

        <script>  
            document.addEventListener('DOMContentLoaded', function() {
                const quizForm = document.getElementById('quizForm'); 
                const resultDiv = document.getElementById('resultForm');
                const resultText = document.getElementById('quizResult');  
                const quizButtonContainer = document.getElementById('quiz_button_container');
                const rewardButton = document.getElementById('reward_button');
                const restartButton = document.getElementById('restart_button');
                const rewardIcon = document.getElementById('rewardIcon');
                
                // 폼이 제출되었을 때의 동작 정의
                quizForm.addEventListener('submit', function(event) {
                    // 폼의 기본 제출 동작 중지
                    event.preventDefault();  
                    
                    // 폼 데이터 수집
                    const formData = new FormData(quizForm);
                    // 폼 요소에 정의된 'data-score-url' 속성을 기반으로 스코어링 URL 가져옴
                    const scoreUrl = quizForm.dataset.scoreUrl; 
                    // 페이지 내 CSRF 토큰 값 가져옴
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    
                    // fetch API를 사용하여 서버에 비동기 POST 요청
                    fetch(scoreUrl, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}' 
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        resultText.textContent = `점수: ${data.score} / ${data.total}`;

                        // 사용자 입력값을 결과 폼의 입력 필드에 설정
                        formData.forEach((value, key) => {
                            const resultInput = resultDiv.querySelector(`input[name="${key}"]`);
                            if (resultInput) {
                                resultInput.value = value;
                            }
                        });

                        // 조건에 따라 버튼 활성화 또는 비활성화
                        if (data.score == data.total) {
                            // 점수가 전체와 같으면 리워드 버튼 활성화
                            rewardButton.disabled = false;
                            restartButton.disabled = true;
                            // 리워드 버튼 클릭 시 아이콘 표시
                            rewardButton.addEventListener('click', function() {
                            rewardIcon.style.display = 'block'; // 아이콘 표시
                            rewardButton.style.display = 'none';
                            });
                        } else {
                            //재도전 버튼 활성화
                            rewardButton.disabled = true;
                            restartButton.disabled = false;
                        }

                        // 재도전 버튼 클릭 시 페이지 새로고침
                        restartButton.addEventListener('click', function() {
                            location.reload();
                        });
                    
                        quizForm.style.display = 'none';
                        quizButtonContainer.style.display = 'none'
                        resultDiv.style.display = 'block';

                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            });                      
        </script>
            
        <script>
            var audio = new Audio(audioFile);;
            function playAudio(audioFile) {

                if (audio && !audio.paused) {
                return;
                }

                if (audio) {
                audio.pause();
                audio.currentTime = 0;
                }

                audio = new Audio(audioFile);

                audio.addEventListener('ended', function() {
                //pass
                });

                audio.play();
            }
        </script>
        
        <script>
            var audioPath = {{user_voice}};
        
            for (var i = 1; i <= 3; i++) {
                for (var j = 1; j <= 4; j++) {
                    var elementId = "h_" + {{book.id}} + "_" + i + "_" + j;
                    var element = document.getElementById(elementId);
        
                    if (element) {
                        element.onclick = function() {
                            playAudio(audioPath[i-1][j-1]);
                        };
                    }
                }
            }
        </script>
        {% include 'footer.html' %}
    </body>
</html>
